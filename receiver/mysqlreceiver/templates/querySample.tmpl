SELECT
    thread.processlist_id AS session_id,
	thread.thread_id AS internal_thread_id,
    COALESCE(thread.processlist_user, '') AS session_user,
    COALESCE(thread.processlist_host) AS client_address,
    COALESCE(thread.processlist_db, '') current_database,
    COALESCE(thread.processlist_command, '') session_command,
    COALESCE(thread.processlist_state, '') session_state,
    COALESCE(statement.sql_text, COALESCE(thread.PROCESSLIST_info, '')) AS sql_text,
    COALESCE(statement.digest, '') AS sql_fingerprint,
    COALESCE(statement.current_schema, '') as current_schema,
    COALESCE(wait.event_id, statement.event_id, 0) AS activity_event_id,
	CASE WHEN wait.thread_id IS NOT NULL
		AND wait.event_id <> wait.end_event_id THEN 'waiting'
	-- actively executing on CPU
	WHEN COALESCE(statement.sql_text, thread.processlist_info) <> '' THEN 'running'
		-- fallback
	ELSE 'other'
	END AS session_status,
    IF(wait.thread_id IS NULL,
        'other',
        COALESCE(
            IF(thread.processlist_state = 'User sleep', 'User sleep',
            IF(wait.event_id = wait.end_event_id, 'CPU', wait.event_name)), 'CPU'
        )
    ) AS wait_event,
    COALESCE(wait.timer_wait/1e12, 0) AS wait_time_seconds
FROM
    performance_schema.threads AS thread
    LEFT JOIN performance_schema.events_statements_current AS statement ON statement.thread_id = thread.thread_id
    LEFT JOIN performance_schema.events_waits_current AS wait ON wait.thread_id = thread.thread_id
WHERE
    thread.processlist_state IS NOT NULL
    AND thread.processlist_command != 'Sleep'
    AND thread.processlist_id != CONNECTION_ID()
    AND thread.PROCESSLIST_COMMAND != 'Daemon'
    AND (wait.EVENT_NAME != 'idle' OR wait.EVENT_NAME IS NULL)
    AND (wait.operation != 'idle' OR wait.operation IS NULL)
    -- events_waits_current can have multiple rows per thread, thus we use EVENT_ID to identify the row we want to use.
    -- Additionally, we want the row with the highest EVENT_ID which reflects the most recent and current wait.
    AND (
        wait.event_id = (
           SELECT
              MAX(current_waits.EVENT_ID)
          FROM  performance_schema.events_waits_current AS current_waits
          Where current_waits.thread_id = thread.thread_id
    ) OR wait.event_id is NULL)
    AND COALESCE(statement.sql_text, thread.PROCESSLIST_info) != ''
LIMIT {{ .limit }}